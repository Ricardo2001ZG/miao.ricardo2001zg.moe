# 基于符号表解析与 Optick 二次开发的图形渲染引擎性能检测工具

## 摘要

在已上线的3D游戏项目中，图形渲染引擎的性能分析与优化为一大痛点。传统性能检测使用外部通用工具与内嵌分析代码，对此均具有局限性，使优化工作较为复杂。

外部通用工具如 Intel VTune，提供包括线程采样与硬件事件采样在内的强大性能分析功能，能够快速定位性能问题。但在获取图形渲染引擎与项目内部部分私有数据这一特定场景中，无法提供支持。同时，VTune仅提供少量接口供外部程序使用，无法做到与项目相关支持平台联动等深度定制开发。

内嵌分析代码基于操作系统计时与操作系统接口，通过时间戳差值与操作系统提供的信息，进行项目性能数据的采集。代码均为开发人员插入，具有较大的灵活性。与开发环境不同，在大型上线项目的生产环境中，需要对原有代码进行插入修改，降低原有代码的完整性与可维护性。

基于上述传统性能检测存在的问题，本文将对两个方向进行研究，并做出改良。
对于外部通用工具存在的局限性，本文采用开源软件Optick进行补充。Optick是一款用于游戏的超轻量级C++性能分析器，提供计时采样、项目数据标签定制等功能。其开源特性可以较好地支持软件代码结合至现有项目中，提供私有数据分析与深度定制功能。
对于内嵌分析代码的缺陷，本文采用动态二进制插桩的形式进行弥补。将原先需要嵌入生产环境中的代码，改为程序运行时动态注入的形式。在保持灵活性与深度采集数据的同时，减少对原有代码的破坏。

对于上述两个方向，本文研发了一种基于符号表解析后动态插桩的二进制注入技术，基于开源软件 Optick 进行二次开发显示性能数据，完成了一款图形渲染引擎性能检测工具。

研究成果已在金山软件旗下子公司，西山居游戏，上线项目之一《剑侠情缘网络版叁重制版》中获得应用，并对数十万用户的实际体验进行了较大的改善。
在上述研究成果的支持下，项目对引擎渲染线程和个别性能较差的场景进行针对性分析，改善产品质量。

关键词：性能优化 图形渲染

## A graphics rendering engine profiler based on symbol analysis and Optick

Abstract: 

Keywords:

## 目录

- 1.前言
- 2.前期调研
    - 2.1 调研内容
        - 2.1.1 上线项目的性能分析需求
        - 2.1.2 目前性能分析的可行技术
    - 2.2 调研分析
        - 2.2.1 Intel VTune 软件应用
            - 2.2.1.1 软件算法效率分析原理
            - 2.2.1.2 VTune在特定分析场景下的局限性
        - 2.2.2 内嵌性能分析代码技术
            - 2.1.3.1 基于时间戳的函数耗时统计原理
            - 2.1.3.2 内嵌性能采集代码在生产环境中的缺陷
- 3.研究与实践
    - 3.1 Optick 对于 VTune 的工程实践补充
        - 3.1.1 实践改进方案
        - 3.1.2 函数耗时统计图表
            - 3.1.2.1 Optick 耗时统计原理
            - 3.1.2.2 实践效果——以全局耗时数据为例
        - 3.1.3 项目标记数据统计
            - 3.1.3.1 标记数据统计原理
            - 3.1.3.2 实践效果——以文件打开路径统计为例
    - 3.2 动态二进制技术对于静态内嵌代码的优化
        - 3.2.1 优化改进方案
        - 3.2.1 Detours 库拦截注入
            - 3.2.1.1 拦截原理
            - 3.2.1.2 实践效果——以DrawCall调用数拦截统计为例
        - 3.2.2 符号表调用
            - 3.2.2.1 符号表介绍
            - 3.2.2.2 实践效果——以KG_PrintLog函数外部调用为例
    - 3.3 基于符号表解析后动态注入的性能数据采集技术
        - 3.3.1 综合改进方案
        - 3.3.2 符号表解析与动态注入结合技术
            - 3.3.2.1 结合原理
            - 3.3.2.2 实践效果——以实时动态注入并统计为例
- 4.研究与实践成果
    - 4.1 局部性能分析场景的应用
        - 4.1.1 DirectX 内 map 函数耗时过长导致的低帧率分析
    - 4.2 项目总体优化效果提升
        - 4.2.1 项目总体优化效果数据展示
- 5.结语
- 参考文献
- 附录
- 致谢

## 正文

### 1.前言

随着3D游戏研发技术的发展，用户对游戏产品的品质要求正在逐渐变高。游戏画面的精细化发展与游戏引擎系统的研发复杂化，使性能分析与优化技术的重要性在不断上升。在此背景下，如 Intel、NVIDIA、AMD 等硬件设计厂商与 Unity、Unreal 等游戏引擎软件研发厂商，均开发了种类繁多的通用图形性能分析软件。同时，对于不同项目的特殊需求，大型游戏研发厂商均各自组建质量保证部门，通过项目内嵌分析代码、研发内部性能工具与使用外部通用图形性能分析软件等方式，针对性地进行质量保证工作。

在此背景下，本文对传统性能检测中使用外部通用工具与内嵌分析代码的两种方案，在特定环境下的分析原理与技术局限性进行了研究。基于上述传统性能检测存在的问题，本文基于 Optick 与动态二进制技术分别做出改良，并研发了一种基于符号表解析后动态插桩的二进制注入技术，基于开源软件 Optick 进行二次开发显示性能数据，完成了一款图形渲染引擎性能检测工具。

### 2.前期调研

### 2.1 调研内容

### 2.1.1 上线项目的性能分析需求
