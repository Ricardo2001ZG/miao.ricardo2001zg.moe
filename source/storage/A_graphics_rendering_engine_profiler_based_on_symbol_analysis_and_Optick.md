# 基于符号表解析与 Optick 二次开发的图形渲染引擎性能检测工具

## 摘要

在已上线的3D游戏项目中，图形渲染引擎的性能分析与优化为一大痛点。传统性能检测使用外部通用工具与内嵌分析代码，对此均具有局限性，使优化工作较为复杂。

外部通用工具如 Intel VTune，提供包括线程采样与硬件事件采样在内的强大性能分析功能，能够快速定位性能问题。但在获取图形渲染引擎与项目内部部分私有数据这一特定场景中，无法提供支持。同时，VTune仅提供少量接口供外部程序使用，无法做到与项目相关支持平台联动等深度定制开发。

内嵌分析代码基于操作系统计时与操作系统接口，通过时间戳差值与操作系统提供的信息，进行项目性能数据的采集。代码均为开发人员插入，具有较大的灵活性。与开发环境不同，在大型上线项目的生产环境中，需要对原有代码进行插入修改，降低原有代码的完整性与可维护性。

基于上述传统性能检测存在的问题，本文将对两个方向进行研究，并做出改良。
对于外部通用工具存在的局限性，本文采用开源软件Optick进行补充。Optick是一款用于游戏的超轻量级C++性能分析器，提供计时采样、项目数据标签定制等功能。其开源特性可以较好地支持软件代码结合至现有项目中，提供私有数据分析与深度定制功能。
对于内嵌分析代码的缺陷，本文采用动态二进制插桩的形式进行弥补。将原先需要嵌入生产环境中的代码，改为程序运行时动态注入的形式。在保持灵活性与深度采集数据的同时，减少对原有代码的破坏。

对于上述两个方向，本文研发了一种基于符号表解析后动态插桩的二进制注入技术，基于开源软件 Optick 进行二次开发显示性能数据，完成了一款图形渲染引擎性能检测工具。

研究成果已在金山软件旗下子公司，西山居游戏，上线项目之一《剑侠情缘网络版叁重制版》中获得应用，并对数十万用户的实际体验进行了较大的改善。在上述研究成果的支持下，对项目中引擎渲染线程和个别性能较差的场景进行了针对性分析，改善产品质量。

关键词：测量 性能优化 图形渲染

## A graphics rendering engine profiler based on symbol analysis and Optick

Abstract: 

Keywords: Performance Analysis    Graphics Rendering

## 目录

- 1.前言
- 2.前期调研
    - 2.1 调研内容
        - 2.1.1 已上线项目性能分析需求
        - 2.1.2 业界性能测量常用技术
    - 2.2 调研分析
        - 2.2.1 Intel VTune 软件应用
            - 2.2.1.1 算法分析功能原理解析
            - 2.2.1.2 VTune在特定分析场景下的局限性
        - 2.2.2 内嵌性能分析代码技术
            - 2.1.3.1 基于时间的函数耗时统计原理与实现
            - 2.1.3.2 内嵌性能采集代码在生产环境中的缺陷
- 3.研究与实践
    - 3.1 Optick 对于 VTune 的工程实践补充
        - 3.1.1 实践改进设计
        - 3.1.2 函数耗时统计图表
            - 3.1.2.1 Optick 耗时统计原理
            - 3.1.2.2 实践效果——以全局耗时数据为例
        - 3.1.3 项目标记数据统计
            - 3.1.3.1 标记数据统计原理
            - 3.1.3.2 实践效果——以文件打开路径统计为例
    - 3.2 动态二进制技术对于静态内嵌代码的优化
        - 3.2.1 优化改进设计
        - 3.2.1 Detours 库拦截注入
            - 3.2.1.1 拦截原理
            - 3.2.1.2 实践效果——以DrawCall调用数拦截统计为例
        - 3.2.2 符号表调用
            - 3.2.2.1 符号表介绍
            - 3.2.2.2 实践效果——以KG_PrintLog函数外部调用为例
    - 3.3 基于符号表解析后动态注入的性能数据采集技术
        - 3.3.1 综合改进设计
        - 3.3.2 符号表解析与动态注入结合技术
            - 3.3.2.1 结合原理
            - 3.3.2.2 实践效果——以实时动态注入并统计为例
- 4.研究与实践成果
    - 4.1 局部性能分析场景的应用
        - 4.1.1 DirectX 内 map 函数耗时过长导致的低帧率分析
    - 4.2 项目总体优化效果提升
        - 4.2.1 项目总体优化效果数据展示
- 5.结语
- 参考文献
- 附录
- 致谢

## 正文

### 1.前言

随着3D游戏研发技术的发展，用户对游戏软件产品的品质要求正在逐渐变高。游戏画面的精细化发展与游戏引擎系统的研发复杂化，使性能测量与优化技术的重要性在不断上升。在此背景下，如 Intel、NVIDIA、AMD 等硬件设计厂商与 Unity、Unreal 等游戏引擎软件研发厂商，均开发了种类繁多的通用图形性能分析软件。同时，对于不同项目的特殊需求，大型游戏研发厂商均各自组建质量保证部门，通过项目内嵌分析代码、研发内部性能工具与使用外部通用图形性能分析软件等方式，针对性地进行质量保证工作。

在此背景下，本文对传统性能检测中使用外部通用工具与内嵌分析代码的两种方案，在特定环境下的分析原理与技术局限性进行了研究。基于上述传统性能检测存在的问题，本文基于 Optick 与动态二进制技术分别做出改良，并研发了一种使用符号表解析后动态插桩的二进制注入技术，基于开源软件 Optick 进行二次开发显示性能数据，完成了一款图形渲染引擎性能检测工具。

### 2.前期调研

### 2.1 调研内容

### 2.1.1 已上线项目性能分析需求

图形硬件的进步推动了交互计算机图形领域研究的爆炸式增长[1]。同时，用户对游戏软件产品的高要求，推动了游戏画面的不断提升。实时渲染算法的高效率运转与硬件的充分利用，成为了保证画面效果的重要因素。对上述两点的保障需求，推动了性能测量与优化技术的发展。从传统的使用计时代码进行测量，到基于硬件事件的深度分析，性能测量技术越发深入。因此，对实时渲染算法的充分优化是可行且非常有必要的。

根据大型3D游戏研发公司中的实际研发经验，上线游戏项目的性能优化需求可以按照相关算法所负责的工作职能，分为渲染代码优化与逻辑代码优化；按照优化时间节点，可分为上线前的开发环境优化与上线后的生产运营环境优化。其中，渲染部分的代码性能，通常为程序中资源开销最大的部分。同时，上线后的生产运营环境优化，与开发环境不同，部分性能问题仅能在用户机器上进行复现，复现难度较大。

### 2.1.2 业界性能分析常用技术

目前而言，游戏开发业界最常使用的仍为以函数耗时统计与系统性能数据获取为核心的测量技术。基于上述两种测量技术，拓展出众多性能分析领域的集成开发环境。以网易游戏雷火工作室为例，在业务实践中，使用与自研开发了数个工具，实现压力测试性能分析集成环境[2]。

其中，Windows 操作系统环境下较为常用的通用测量工具为 Intel VTune Performance Analyzer。Intel VTune 是一款用于单线程与多线程应用程序的性能分析工具，可用于定位应用程序或整个系统中最为耗时的功能[3]。

### 2.2 调研分析

### 2.2.1 Intel VTune 软件应用

### 2.2.1.1 算法分析功能原理解析

在工程实践中，对于 Intel VTune，最为常用的功能是 Algorithm analysis 算法分析分类下的 Hotspots 热点功能。热点功能基于 VTune 内置的用户模式采样与跟踪收集功能实现。

用户模式采样与跟踪收集器通过中断进程，收集所有活动指令地址的值，并为每个样本捕获一个调用队列。采样指令指针与它们的调用队列，通常为堆栈，被保存到收集数据文件中。统计带有调用队列的 IP 样本可在软件内置浏览器中显示调用图或最耗时的调用路径。使用该数据可以了解具有统计重要性的代码片段的控制流[4]。

基于该功能生成的函数调用图或调用路径，可以清晰展示软件中耗时较长的局部函数，定位到性能热点片段，从而针对性地对软件热点进行性能优化。

### 2.2.1.2 VTune在特定分析场景下的局限性

一般而言，在工程内部网络的开发环境中，可以较好地通过 VTune 等通用工具进行软件性能测量，快速发现性能热点。但在外部网络与面向用户的生产运营环境中，当性能问题仅能在用户机器上复现时，大型通用工具通常难以使用。开发人员远程调试部署与指导用户使用均具有较高的时间与人力成本。

除生产环境的局限外，通用软件的通用性对于无法获取私有数据也是一个负担。在该场景下，图形渲染引擎的内部性能数据无法被通用工具获取。
以 LOD (Levels of Detail, 多层次细节)技术为例。LOD是一项通过对模型进行细节分级加载，从而减轻渲染压力的优化技术。在部分性能分析场景中，需要对引擎的各层级模型数量进行统计，确定各层级的数量是否有过多或超出引擎渲染能力范围的情形发生。
以文件打开性能测量为例，部分场景下，需要对引擎内各个模型文件的载入时间进行测量。由于较多游戏采用自身独有的数据打包形式，通用工具无法获取专有算法压缩与解压的文件情况。

### 2.2.2 内嵌性能分析代码技术

### 2.1.3.1 基于时间的函数耗时统计原理与实现

基于时间的函数耗时统计是性能测量领域最为通用的方式之一。其实现方式一般为，通过获取系统时间或硬件支持的高精度计时器数据，在函数调用前进行记录，并在函数调用完毕后进行第二次记录，通过计算差值获取函数的实际运行时间。

在实际生产环境中，基于编程语言本身或系统提供的普通接口，通常仅能获取到毫秒级的精度数据。而在渲染性能分析中，以帧为单位的统计常为毫秒级，其单帧内的较多函数调用以微秒级计算。在此背景下，本文使用 Windows 系统环境中的 QueryPerformanceFrequency 函数，实现了一个简单的计时器用于展示。

该函数基于硬件高分辨率性能计数器，在调用时返回一个独立于外部时间参考系的高精度时间戳，可用于函数间隔时间测量。其精度根据硬件而细微变化，在循环时间为 3 GHz的处理器上，其精度大致为360纳秒[5]，可用于微秒级测量。

[图片](实现代码，20行左右)

### 2.1.3.2 内嵌性能采集代码在生产环境中的缺陷

在上述实现中，本文采用了在函数调用前后写入耗时计算代码的方式进行统计。在开发环境中，引擎内部数据与少量函数耗时均可以使用嵌入代码并输出日志的形式进行监测。该代码均为开发人员插入，获取数据方面具有较大的灵活性。

与开发环境不同，在大型上线项目的生产环境中，需要对原有代码进行插入修改，降低原有代码的完整性与可维护性。大量的日志与测试代码会影响业务代码本身的可读性，如图所示，大量无效日志对性能分析产生了较大干扰。

[图片](Log截图)

除对原有代码的干扰外，生产环境中插入的性能采集代码，会在一定程度上影响图形渲染引擎的工作效率。以VTune自身的数据展示为例，其性能开销程度在 3-5% 。通用采集工具的大规模采集性能影响较大，而小规模的测试代码重复插入会使开发人员难以维护，对于每个测试点都要进行手动嵌入测试代码，其工程量较大。

### 3.研究与实践

### 3.1 Optick 对于 VTune 的工程实践补充

### 3.1.1 实践改进设计

本文采用开源软件 Optick 对 Intel VTune 进行了补充，对针对性性能分析提供了较好的实践。Optick 是一款用于游戏的超轻量级 C++ 分析器，提供了包括采样在内的高效性能分析与优化所需的必要工具[6]。

Optick基于时间戳进行耗时统计，但与VTune的通用采集不同，其采集需要在代码内调用相关接口，在实践中，接口以C++ 代码宏在需采样函数中插入的形式调用。与通用采集和插入性能采集代码相比，降低了通用采集时的性能开销，仅针对指定函数进行采样。同时，仅需一行代码的调用宏，也提高了测试代码的可维护性。

除具有性能与可维护性优势以外，Optick也针对工程内部参数提供了 tags 标记的功能。开启标记功能后，可将自定义数据写入当前宏的采集数据中。对于通用工具难以采集的引擎私有数据，可使用该功能进行数据记录。

### 3.1.2 函数耗时统计图表

### 3.1.2.1 Optick 耗时统计原理



### 3.1.2.2 实践效果——以全局耗时数据为例

### 3.1.3 标记数据统计

### 3.1.3.1 标记数据统计原理
### 3.1.3.2 实践效果——以文件打开路径统计为例

## 参考文献

[1]Tomas Akenine-Möller,Eric Haines,Naty Hoffman,et al.Real-Time Rendering Fourth Edition[M].Boca Raton,FL,USA:A K Peters/CRC Press,2018:1-2.

[2]网易游戏雷火事业群.【游戏测试专题】端游的压力测试分享[R/OL].https://zhuanlan.zhihu.com/p/503044178 , 2022-04-29.

[3]Intel.Intel® VTune™ Profiler User Guide Introduction[DB/OL].https://www.intel.com/content/www/us/en/develop/documentation/vtune-help/top/introduction.html , 2022-03-22.

[4]Intel.User-Mode Sampling and Tracing Collection[DB/OL].https://www.intel.com/content/www/us/en/develop/documentation/vtune-help/top/analyze-performance/user-mode-sampling-and-tracing-collection.html , 2022-03-22.

[5]Microsoft.Acquiring high-resolution time stamps[DB/OL].https://docs.microsoft.com/en-us/windows/win32/sysinfo/acquiring-high-resolution-time-stamps#resolution-precision-accuracy-and-stability , 2022-01-05.

[6]Bombomby.Optick wiki[DB/OL].https://github.com/bombomby/optick , 2022